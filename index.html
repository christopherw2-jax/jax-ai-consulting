// Structured DynamicAIAssessment class with strict question order
class DynamicAIAssessment {
    constructor() {
        this.conversationHistory = [];
        this.businessData = {};
        this.isListening = false;
        this.recognition = null;
        this.solutionProposalGenerated = false;
        this.totalTokensUsed = 0;
        this.nameUsageCount = 0;
        
        // STRICT question order - must follow this sequence
        this.questionSequence = [
            {
                id: 'contact_name',
                question: "What's your name, and could you tell me the name and location of your business?",
                dataKeys: ['contact_name', 'business_name', 'business_location'],
                label: 'Name & Business Details'
            },
            {
                id: 'business_type',
                question: "What type of business do you run?",
                dataKeys: ['business_type'],
                label: 'Business Type'
            },
            {
                id: 'pain_points',
                question: "What are the main challenges you're currently facing in your business?",
                dataKeys: ['pain_points'],
                label: 'Main Challenges'
            },
            {
                id: 'current_solution',
                question: "What solutions do you currently have in place for these challenges, or are you handling everything manually?",
                dataKeys: ['current_solution'],
                label: 'Current Solutions'
            },
            {
                id: 'time_savings',
                question: "How many hours per week do you think automation could save you?",
                dataKeys: ['time_savings'],
                label: 'Potential Time Savings'
            },
            {
                id: 'time_value',
                question: "What do you value your time at per hour? This helps me calculate the exact ROI for your business.",
                dataKeys: ['time_value'],
                label: 'Time Value'
            },
            {
                id: 'contact_email',
                question: "Could you provide your email address so I can send you the detailed proposal?",
                dataKeys: ['contact_email'],
                label: 'Email Address'
            },
            {
                id: 'contact_phone',
                question: "And your phone number so we can follow up to schedule a consultation?",
                dataKeys: ['contact_phone'],
                label: 'Phone Number'
            }
        ];
        
        this.currentQuestionIndex = 0;
        
        // Track captured data
        this.capturedData = {
            contact_name: false,
            business_name: false,
            business_location: false,
            business_type: false,
            pain_points: false,
            current_solution: false,
            time_savings: false,
            time_value: false,
            contact_email: false,
            contact_phone: false
        };
        
        window.assessmentSystem = this;
        this.init();
        
        // Auto-start with embedded API key
        setTimeout(() => {
            saveApiKey();
        }, 1000);
    }

    init() {
        this.setupSpeechRecognition();
        this.setupEventListeners();
    }

    setupSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.lang = 'en-US';

            this.recognition.onstart = () => {
                this.isListening = true;
                this.updateVoiceButton();
                this.updateStatus('Listening... speak now');
            };

            this.recognition.onend = () => {
                this.isListening = false;
                this.updateVoiceButton();
                this.updateStatus('');
            };

            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('textInput').value = transcript;
                this.sendMessage();
            };

            this.recognition.onerror = () => {
                this.showError('Speech recognition error. Please try typing instead.');
                this.isListening = false;
                this.updateVoiceButton();
            };
        }
    }

    setupEventListeners() {
        document.getElementById('voiceButton').addEventListener('click', () => {
            if (this.isListening) {
                this.stopListening();
            } else {
                this.startListening();
            }
        });

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }

    startAssessment() {
        const welcomeMessage = `Hi there! I'm your AI consultant from JAX AI Consulting, and I'm excited to learn about your business and explore how we can help you save 10+ hours per week through smart automation.

To give you the most personalized recommendations, let me start by getting to know you and your business.

${this.questionSequence[0].question}`;

        this.addMessage(welcomeMessage, 'ai');
        this.updateStatus(`Question ${this.currentQuestionIndex + 1} of ${this.questionSequence.length}`);
    }

    startListening() {
        if (this.recognition) {
            this.recognition.start();
        }
    }

    stopListening() {
        if (this.recognition) {
            this.recognition.stop();
        }
    }

    updateVoiceButton() {
        const button = document.getElementById('voiceButton');
        
        if (this.isListening) {
            button.classList.add('listening');
            button.innerHTML = 'ðŸ”´';
            button.title = 'Click to stop listening';
        } else {
            button.classList.remove('listening');
            button.innerHTML = 'ðŸŽ¤';
            button.title = 'Click to speak';
        }
    }

    updateStatus(message) {
        document.getElementById('statusText').textContent = message;
    }

    getCompletionProgress() {
        const completed = Object.values(this.capturedData).filter(captured => captured).length;
        return Math.round((completed / Object.keys(this.capturedData).length) * 100);
    }

    shouldUseName() {
        this.nameUsageCount++;
        return this.nameUsageCount === 1 || this.nameUsageCount % 4 === 0;
    }

    async sendMessage() {
        const input = document.getElementById('textInput');
        const message = input.value.trim();
        
        if (!message) return;

        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = 'Sending...';

        this.addMessage(message, 'user');
        input.value = '';

        // Check if this is a response to consultation question (after solution proposal)
        if (this.solutionProposalGenerated) {
            if (message.toLowerCase().includes('yes') || message.toLowerCase().includes('schedule') || message.toLowerCase().includes('consultation')) {
                this.handleConsultationRequest(message);
            } else {
                this.addMessage('Thank you for your response. Let me know if you have any questions or if you\'d like to schedule a consultation!', 'ai');
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Send';
            return;
        }

        try {
            // Extract data from the user's message
            this.extractDataFromMessage(message);
            
            // Check if we have all data and should generate proposal
            if (this.hasAllRequiredData()) {
                this.addMessage('Perfect! I have all the information I need. Let me analyze your business and create a comprehensive automation proposal with accurate ROI calculations...', 'ai');
                this.updateStatus('Generating your personalized solution proposal...');
                setTimeout(() => {
                    this.generateSolutionProposal();
                }, 1500);
            } else {
                // Move to next question in sequence
                this.moveToNextQuestion();
            }
            
        } catch (error) {
            this.showError('Error processing your message. Please try again.');
            console.error('Error:', error);
        }
        
        submitButton.disabled = false;
        submitButton.textContent = 'Send';
    }

    extractDataFromMessage(message) {
        const lowerMessage = message.toLowerCase();
        
        // Extract name (multiple patterns)
        if (!this.capturedData.contact_name) {
            const namePatterns = [
                /(?:my name is|i'm|i am|call me|this is)\s+([a-zA-Z]+(?:\s+[a-zA-Z]+)*)/i,
                /^([a-zA-Z]+(?:\s+[a-zA-Z]+)*?)(?:\s+(?:and|from|here|owner|,|\.|!|-))/i
            ];
            for (const pattern of namePatterns) {
                const match = message.match(pattern);
                if (match && match[1] && match[1].split(' ').length <= 3) {
                    let name = match[1].trim().replace(/\b(owner|manager|from|and|the|business|company|shop|salon|clinic)\b/gi, '').trim();
                    if (name && name.length > 1) {
                        this.businessData.contact_name = name;
                        this.capturedData.contact_name = true;
                        break;
                    }
                }
            }
        }

        // Extract business name
        if (!this.capturedData.business_name) {
            const businessNamePatterns = [
                /(?:run|own|called|business)\s+(?:a\s+)?(.+?)(?:\s+in|\s+located|\s+at|$)/i,
                /(?:restaurant|salon|clinic|shop|store|business|company)\s+called\s+([^.!?,\n]+)/i
            ];
            for (const pattern of businessNamePatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    let businessName = match[1].trim().replace(/\b(is|in|located|here|the|a|called)\b/gi, '').trim();
                    if (businessName && businessName.length > 2) {
                        this.businessData.business_name = businessName;
                        this.capturedData.business_name = true;
                        break;
                    }
                }
            }
        }

        // Extract location
        if (!this.capturedData.business_location) {
            const locationPatterns = [
                /(?:in|located in|based in|from|at)\s+([^.!?,\n]+)/i,
                /(?:Jacksonville|Jax|Florida|FL|Miami|Tampa|Orlando)\b[^.!?,\n]*/i
            ];
            for (const pattern of locationPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    let location = match[1].trim().replace(/\b(the|a|is|and)\b/gi, '').trim();
                    if (location && location.length > 2) {
                        this.businessData.business_location = location;
                        this.capturedData.business_location = true;
                        break;
                    }
                } else if (match && match[0]) {
                    this.businessData.business_location = match[0].trim();
                    this.capturedData.business_location = true;
                    break;
                }
            }
        }

        // Extract business type
        if (!this.capturedData.business_type) {
            const businessTypePatterns = [
                /(?:type of business|run a|own a|operate a)\s+([^.!?,\n]+)/i,
                /\b(restaurant|salon|spa|clinic|shop|store|practice|firm|company|dental|medical|retail|gym|fitness|bakery|cafe|bar|hotel|grooming|pet)\b/i
            ];
            for (const pattern of businessTypePatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    this.businessData.business_type = match[1].trim();
                    this.capturedData.business_type = true;
                    break;
                } else if (match && match[0]) {
                    this.businessData.business_type = match[0].trim();
                    this.capturedData.business_type = true;
                    break;
                }
            }
        }

        // Extract pain points
        if (!this.capturedData.pain_points) {
            if (message.length > 10) { // Any substantive response to challenges question
                this.businessData.pain_points = message;
                this.capturedData.pain_points = true;
            }
        }

        // Extract current solutions
        if (!this.capturedData.current_solution) {
            if (message.length > 5) { // Any response to current solutions question
                this.businessData.current_solution = message;
                this.capturedData.current_solution = true;
            }
        }

        // Extract time savings
        if (!this.capturedData.time_savings) {
            const timeMatch = message.match(/(\d+(?:\.\d+)?)/);
            if (timeMatch || lowerMessage.includes('hour')) {
                this.businessData.time_savings = message;
                this.capturedData.time_savings = true;
            }
        }

        // Extract time value
        if (!this.capturedData.time_value) {
            const valueMatch = message.match(/\$?(\d+(?:,\d{3})*(?:\.\d{2})?)/);
            if (valueMatch) {
                this.businessData.time_value = message;
                this.capturedData.time_value = true;
            }
        }

        // Extract email
        if (!this.capturedData.contact_email) {
            const emailMatch = message.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
            if (emailMatch) {
                this.businessData.contact_email = emailMatch[1];
                this.capturedData.contact_email = true;
            }
        }

        // Extract phone
        if (!this.capturedData.contact_phone) {
            const phoneMatch = message.match(/(\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4})/);
            if (phoneMatch) {
                this.businessData.contact_phone = phoneMatch[1];
                this.capturedData.contact_phone = true;
            }
        }
    }

    moveToNextQuestion() {
        const currentQuestion = this.questionSequence[this.currentQuestionIndex];
        
        // Check if current question data is captured
        const currentDataCaptured = currentQuestion.dataKeys.every(key => this.capturedData[key]);
        
        if (currentDataCaptured && this.currentQuestionIndex < this.questionSequence.length - 1) {
            // Move to next question
            this.currentQuestionIndex++;
            const nextQuestion = this.questionSequence[this.currentQuestionIndex];
            
            // Create personalized response
            const name = this.businessData.contact_name ? this.businessData.contact_name.split(' ')[0] : '';
            const businessName = this.businessData.business_name || '';
            const useName = this.shouldUseName();
            
            let response = '';
            if (useName && name) {
                response = `Thank you, ${name}! `;
            } else {
                response = 'Thank you! ';
            }
            
            // Add business reference if available
            if (businessName && this.currentQuestionIndex > 2) {
                response += `For ${businessName}, ${nextQuestion.question.toLowerCase()}`;
            } else {
                response += nextQuestion.question;
            }
            
            this.addMessage(response, 'ai');
            this.updateStatus(`Question ${this.currentQuestionIndex + 1} of ${this.questionSequence.length}`);
        } else if (!currentDataCaptured) {
            // Re-ask current question if data not captured
            const question = currentQuestion.question;
            this.addMessage(`Could you please provide that information? ${question}`, 'ai');
        }
    }

    hasAllRequiredData() {
        return Object.values(this.capturedData).every(captured => captured);
    }

    handleConsultationRequest(message) {
        // Add user response to conversation
        this.conversationHistory.push({
            role: 'user',
            content: message
        });

        // Send assessment data to webhook
        this.sendAssessmentToFreeWebhook();
        
        // Show confirmation message
        const name = this.businessData.contact_name ? `, ${this.businessData.contact_name.split(' ')[0]}` : '';
        const businessName = this.businessData.business_name ? ` for ${this.businessData.business_name}` : '';
        this.addMessage(`Perfect${name}! I've sent your detailed assessment${businessName} to JAX AI Consulting. Based on your ${this.businessData.business_type || 'business'} in ${this.businessData.business_location || 'your area'}, someone will reach out within 24 hours to schedule your consultation. Thank you for your interest!`, 'ai');
        
        // Hide input section
        document.getElementById('inputSection').style.display = 'none';
        this.updateStatus('Assessment complete - You will be contacted within 24 hours');
    }

    async sendAssessmentToFreeWebhook() {
        try {
            const webhookUrls = [
                // Add your webhook URLs here
            ];

            const assessmentPayload = {
                timestamp: new Date().toISOString(),
                source: 'JAX AI Assessment',
                contactName: this.businessData.contact_name || '',
                businessName: this.businessData.business_name || '',
                businessLocation: this.businessData.business_location || '',
                businessType: this.businessData.business_type || '',
                contactEmail: this.businessData.contact_email || '',
                contactPhone: this.businessData.contact_phone || '',
                painPoints: this.businessData.pain_points || '',
                currentSolution: this.businessData.current_solution || '',
                timeSavings: this.businessData.time_savings || '',
                timeValue: this.businessData.time_value || '',
                leadScore: this.calculateLeadScore(),
                tokensUsed: this.totalTokensUsed,
                aiProvider: 'OpenAI ChatGPT-4o',
                dataCompleteness: this.getCompletionProgress(),
                conversationSummary: this.conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n\n'),
                solutionProposal: this.getSolutionFromConversation()
            };

            // Try webhook
            let webhookSuccess = false;
            for (const url of webhookUrls) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(assessmentPayload)
                    });
                    if (response.ok) {
                        webhookSuccess = true;
                        break;
                    }
                } catch (error) {
                    console.log('Webhook failed');
                }
            }

            // Email backup
            this.openEnhancedEmail(assessmentPayload);

        } catch (error) {
            console.error('Webhook error:', error);
            this.openEnhancedEmail();
        }
    }

    openEnhancedEmail(assessmentData = null) {
        const contactName = this.businessData.contact_name || 'Not provided';
        const businessName = this.businessData.business_name || 'Not provided';
        const businessLocation = this.businessData.business_location || 'Not provided';
        const businessType = this.businessData.business_type || 'Not provided';
        const contactEmail = this.businessData.contact_email || 'Not provided';
        const contactPhone = this.businessData.contact_phone || 'Not provided';

        const emailSubject = `ðŸ”¥ HOT LEAD: ${contactName} from ${businessName} (Score: ${this.calculateLeadScore()}/100)`;
        
        const emailBody = `URGENT: New qualified lead wants consultation!

CONTACT INFORMATION:
===================
Name: ${contactName}
Business: ${businessName}
Location: ${businessLocation}
Type: ${businessType}
Email: ${contactEmail}
Phone: ${contactPhone}

ASSESSMENT SUMMARY:
==================
Pain Points: ${this.businessData.pain_points || 'Not provided'}
Current Solutions: ${this.businessData.current_solution || 'Not provided'}
Potential Time Savings: ${this.businessData.time_savings || 'Not provided'}
Time Value: ${this.businessData.time_value || 'Not provided'}
Lead Score: ${this.calculateLeadScore()}/100
Data Completeness: ${this.getCompletionProgress()}%

AI PROVIDER: ChatGPT-4o
TOKENS USED: ${this.totalTokensUsed}

FULL CONVERSATION:
==================
${this.conversationHistory.map(msg => `${msg.role.toUpperCase()}: ${msg.content}`).join('\n\n')}

ðŸŽ¯ ACTION REQUIRED: Contact within 24 hours to schedule consultation!`;

        const emailLink = `mailto:hello@jaxaiconsulting.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
        window.open(emailLink, '_blank');
    }

    getSolutionFromConversation() {
        const solutionMessage = this.conversationHistory
            .slice()
            .reverse()
            .find(msg => msg.role === 'assistant' && (
                msg.content.includes('AUTOMATION OPPORTUNITIES') || 
                msg.content.includes('SOLUTION PROPOSAL') ||
                msg.content.includes('ROI ANALYSIS')
            ));
        
        return solutionMessage ? solutionMessage.content : 'Solution proposal generated';
    }

    calculateLeadScore() {
        let score = 25; // Base score
        
        // Data completeness
        const completeness = this.getCompletionProgress();
        score += Math.round(completeness * 0.3);
        
        // Time value scoring
        const timeValue = this.extractTimeValue(this.businessData.time_value);
        if (timeValue >= 200) score += 40;
        else if (timeValue >= 100) score += 30;
        else if (timeValue >= 75) score += 25;
        else if (timeValue >= 50) score += 20;
        else if (timeValue >= 25) score += 10;
        
        // Time savings potential
        const timeSavings = this.extractTimeSavings(this.businessData.time_savings);
        if (timeSavings >= 15) score += 35;
        else if (timeSavings >= 10) score += 25;
        else if (timeSavings >= 5) score += 15;
        else if (timeSavings >= 2) score += 10;
        
        // Business type scoring
        const businessType = (this.businessData.business_type || '').toLowerCase();
        if (businessType.includes('salon') || businessType.includes('spa') || 
            businessType.includes('clinic') || businessType.includes('dental') ||
            businessType.includes('medical') || businessType.includes('appointment') ||
            businessType.includes('grooming') || businessType.includes('pet') ||
            businessType.includes('restaurant')) {
            score += 15;
        } else if (businessType.includes('retail') || businessType.includes('service')) {
            score += 10;
        }
        
        return Math.min(score, 100);
    }

    extractTimeValue(timeValueText) {
        if (!timeValueText) return 0;
        const matches = timeValueText.match(/\$?(\d+(?:,\d{3})*(?:\.\d{2})?)/);
        return matches ? parseFloat(matches[1].replace(/,/g, '')) : 0;
    }

    extractTimeSavings(timeSavingsText) {
        if (!timeSavingsText) return 0;
        const hourMatches = timeSavingsText.match(/(\d+(?:\.\d+)?)\s*(?:hours?|hrs?)/i);
        if (hourMatches) return parseFloat(hourMatches[1]);
        
        const numberMatches = timeSavingsText.match(/(\d+(?:\.\d+)?)/);
        return numberMatches ? parseFloat(numberMatches[1]) : 0;
    }

    async generateSolutionProposal() {
        setTimeout(async () => {
            try {
                const solutionPrompt = `Create a comprehensive AI solution proposal for this business owner using their exact information.

BUSINESS OWNER: ${this.businessData.contact_name || 'Business Owner'}
BUSINESS: ${this.businessData.business_name || 'Their Business'}
LOCATION: ${this.businessData.business_location || 'Location not specified'}
BUSINESS TYPE: ${this.businessData.business_type || 'Small Business'}
MAIN CHALLENGES: ${this.businessData.pain_points || 'Manual processes'}
CURRENT SOLUTIONS: ${this.businessData.current_solution || 'Manual processes'}
POTENTIAL TIME SAVINGS: ${this.businessData.time_savings || '5 hours per week'}
TIME VALUE: ${this.businessData.time_value || '$50 per hour'}

CRITICAL INSTRUCTIONS:
1. Use their EXACT time value and time savings - no assumptions
2. Calculate precise ROI using their real numbers
3. Do NOT include "Local Advantage" section
4. End with ONLY the consultation question - no signatures

PROPOSAL STRUCTURE:

1. **EXECUTIVE SUMMARY**
   - Address by first name
   - Reference business name and location
   - Mention specific challenges

2. **DETAILED ROI ANALYSIS**
   - Use EXACT time value and savings
   - Calculate: (time savings Ã— time value Ã— 52 weeks) = annual savings
   - JAX AI fee: 10% of annual savings
   - Show ROI percentage

3. **CUSTOM AUTOMATION SOLUTIONS**
   - 2-3 solutions for their specific challenges
   - Reference their business name

4. **IMPLEMENTATION TIMELINE**
   - 6-week timeline
   - Pay-for-performance model

5. **NEXT STEPS**
   - "Would you like to schedule an in-person consultation to discuss implementing this solution for [business name]?"

Use only their real data - no placeholders or assumptions.`;

                this.addMessage('Creating your personalized automation strategy with precise ROI calculations...', 'thinking');

                const response = await this.getAISolutionResponse(solutionPrompt);
                this.removeLastMessage();
                this.addMessage(response, 'ai');
                
                this.solutionProposalGenerated = true;
                this.updateStatus('Please let me know if you\'d like to schedule a consultation');

            } catch (error) {
                this.removeLastMessage();
                this.showError('Error generating your solution proposal. Please refresh and try again.');
            }
        }, 1500);
    }

    async getAISolutionResponse(solutionPrompt) {
        try {
            const functionUrl = window.location.hostname === 'localhost' 
                ? 'http://localhost:8888/.netlify/functions/ai-assessment'
                : '/.netlify/functions/ai-assessment';

            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: solutionPrompt }],
                    systemPrompt: 'You are an expert AI business consultant. Use ONLY the exact data provided. Never assume numbers. Create personalized proposals without signatures.',
                    maxTokens: 1500
                })
            });

            if (!response.ok) {
                throw new Error(`Backend request failed with status ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.content[0].text;

            if (data.usage) {
                this.totalTokensUsed += data.usage.total_tokens;
            }

            this.conversationHistory.push({
                role: 'assistant',
                content: aiResponse
            });

            return aiResponse;

        } catch (error) {
            console.error('Solution API Error:', error);
            throw error;
        }
    }

    addMessage(text, type) {
        const container = document.getElementById('conversationDisplay');
        const message = document.createElement('div');
        message.className = `message ${type}`;
        
        const label = document.createElement('div');
        label.className = 'message-label';
        
        if (type === 'ai') {
            label.textContent = 'AI Consultant (ChatGPT-4o)';
        } else if (type === 'user') {
            label.textContent = 'You';
        } else if (type === 'thinking') {
            label.textContent = 'AI is analyzing...';
        }
        
        const content = document.createElement('div');
        content.className = 'message-content';
        
        let formattedText = text
            .replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/## (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/# (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/^\* (.*?)$/gm, 'â€¢ $1')
            .replace(/^- (.*?)$/gm, 'â€¢ $1')
            .replace(/^(\d+)\. (.*?)$/gm, '<strong>$1.</strong> $2')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        if (!formattedText.includes('<h3>') && !formattedText.includes('<p>')) {
            formattedText = '<p>' + formattedText + '</p>';
        } else if (formattedText.includes('<br>') && !formattedText.includes('<p>')) {
            formattedText = '<p>' + formattedText + '</p>';
        }
        
        content.innerHTML = formattedText;
        
        message.appendChild(label);
        message.appendChild(content);
        container.appendChild(message);
        
        container.scrollTop = container.scrollHeight;
    }

    removeLastMessage() {
        const container = document.getElementById('conversationDisplay');
        const lastMessage = container.lastElementChild;
        if (lastMessage) {
            container.removeChild(lastMessage);
        }
    }

    showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}
