// Fixed DynamicAIAssessment class with strict question order and guaranteed proposal generation
class DynamicAIAssessment {
    constructor() {
        this.conversationHistory = [];
        this.businessData = {};
        this.isListening = false;
        this.recognition = null;
        this.solutionProposalGenerated = false;
        this.totalTokensUsed = 0;
        this.nameUsageCount = 0;
        
        // STRICT question order - must follow this exact sequence
        this.questionSequence = [
            {
                id: 'contact_info',
                question: "What's your name, business name, and location?",
                dataKeys: ['contact_name', 'business_name', 'business_location'],
                label: 'Contact & Business Info',
                required: true
            },
            {
                id: 'business_type',
                question: "What type of business do you run?",
                dataKeys: ['business_type'],
                label: 'Business Type',
                required: true
            },
            {
                id: 'main_challenges',
                question: "What are the main challenges or time-consuming tasks in your business?",
                dataKeys: ['pain_points'],
                label: 'Main Challenges',
                required: true
            },
            {
                id: 'current_solutions',
                question: "What solutions do you currently have in place for these challenges, or are you handling everything manually?",
                dataKeys: ['current_solution'],
                label: 'Current Solutions',
                required: true
            },
            {
                id: 'time_savings',
                question: "How many hours per week do you think automation could save you?",
                dataKeys: ['time_savings'],
                label: 'Potential Time Savings',
                required: true
            },
            {
                id: 'time_value',
                question: "What do you value your time at per hour? This helps me calculate the exact ROI for your business.",
                dataKeys: ['time_value'],
                label: 'Time Value',
                required: true
            },
            {
                id: 'contact_details',
                question: "Could you provide your email and phone number so I can send you the detailed proposal and follow up?",
                dataKeys: ['contact_email', 'contact_phone'],
                label: 'Contact Details',
                required: false
            }
        ];
        
        this.currentQuestionIndex = 0;
        this.questionsAnswered = 0;
        
        // Track captured data
        this.capturedData = {
            contact_name: false,
            business_name: false,
            business_location: false,
            business_type: false,
            pain_points: false,
            current_solution: false,
            time_savings: false,
            time_value: false,
            contact_email: false,
            contact_phone: false
        };
        
        window.assessmentSystem = this;
        this.init();
        
        // Auto-start with embedded API key
        setTimeout(() => {
            saveApiKey();
        }, 1000);
    }

    init() {
        this.setupSpeechRecognition();
        this.setupEventListeners();
    }

    setupSpeechRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            this.recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.lang = 'en-US';

            this.recognition.onstart = () => {
                this.isListening = true;
                this.updateVoiceButton();
                this.updateStatus('Listening... speak now');
            };

            this.recognition.onend = () => {
                this.isListening = false;
                this.updateVoiceButton();
                this.updateStatus('');
            };

            this.recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('textInput').value = transcript;
                this.sendMessage();
            };

            this.recognition.onerror = () => {
                this.showError('Speech recognition error. Please try typing instead.');
                this.isListening = false;
                this.updateVoiceButton();
            };
        }
    }

    setupEventListeners() {
        document.getElementById('voiceButton').addEventListener('click', () => {
            if (this.isListening) {
                this.stopListening();
            } else {
                this.startListening();
            }
        });

        document.getElementById('textInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
    }

    startAssessment() {
        const welcomeMessage = `Hi there! I'm your AI consultant from JAX AI Consulting, and I'm excited to learn about your business and explore how we can help you save 10+ hours per week through smart automation.

I have just 6 focused questions to create your personalized automation proposal with exact ROI calculations.

${this.questionSequence[0].question}`;

        this.addMessage(welcomeMessage, 'ai');
        this.updateStatus(`Question ${this.currentQuestionIndex + 1} of ${this.questionSequence.length}`);
    }

    startListening() {
        if (this.recognition) {
            this.recognition.start();
        }
    }

    stopListening() {
        if (this.recognition) {
            this.recognition.stop();
        }
    }

    updateVoiceButton() {
        const button = document.getElementById('voiceButton');
        
        if (this.isListening) {
            button.classList.add('listening');
            button.innerHTML = 'ðŸ”´';
            button.title = 'Click to stop listening';
        } else {
            button.classList.remove('listening');
            button.innerHTML = 'ðŸŽ¤';
            button.title = 'Click to speak';
        }
    }

    updateStatus(message) {
        document.getElementById('statusText').textContent = message;
    }

    getCompletionProgress() {
        const completed = Object.values(this.capturedData).filter(captured => captured).length;
        return Math.round((completed / Object.keys(this.capturedData).length) * 100);
    }

    async sendMessage() {
        const input = document.getElementById('textInput');
        const message = input.value.trim();
        
        if (!message) return;

        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        submitButton.textContent = 'Sending...';

        this.addMessage(message, 'user');
        input.value = '';

        // Check if this is a response to consultation question (after solution proposal)
        if (this.solutionProposalGenerated) {
            if (message.toLowerCase().includes('yes') || message.toLowerCase().includes('schedule') || message.toLowerCase().includes('consultation')) {
                this.handleConsultationRequest(message);
            } else {
                this.addMessage('Thank you for your response. Let me know if you have any questions or if you\'d like to schedule a consultation!', 'ai');
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Send';
            return;
        }

        try {
            // Extract data from the user's message
            this.extractDataFromMessage(message);
            
            // Always move to next question OR generate proposal
            this.questionsAnswered++;
            
            // After 6 questions (core required data), generate proposal
            if (this.questionsAnswered >= 6) {
                this.addMessage('Perfect! I have all the core information I need. Let me analyze your business and create a comprehensive automation proposal with accurate ROI calculations...', 'ai');
                this.updateStatus('Generating your personalized solution proposal...');
                setTimeout(() => {
                    this.generateSolutionProposal();
                }, 1500);
            } else if (this.currentQuestionIndex < this.questionSequence.length - 1) {
                // Move to next question
                this.currentQuestionIndex++;
                this.askNextQuestion();
            } else {
                // Fallback - generate proposal if we've gone through all questions
                this.addMessage('Thank you! Let me create your automation proposal...', 'ai');
                this.updateStatus('Generating your personalized solution proposal...');
                setTimeout(() => {
                    this.generateSolutionProposal();
                }, 1500);
            }
            
        } catch (error) {
            this.showError('Error processing your message. Please try again.');
            console.error('Error:', error);
        }
        
        submitButton.disabled = false;
        submitButton.textContent = 'Send';
    }

    askNextQuestion() {
        const nextQuestion = this.questionSequence[this.currentQuestionIndex];
        
        // Create personalized response
        const name = this.businessData.contact_name ? this.businessData.contact_name.split(' ')[0] : '';
        const businessName = this.businessData.business_name || '';
        
        let response = 'Thank you! ';
        
        // Add business reference if available and past the first question
        if (businessName && this.currentQuestionIndex > 1) {
            response += `For ${businessName}, ${nextQuestion.question.toLowerCase()}`;
        } else {
            response += nextQuestion.question;
        }
        
        this.addMessage(response, 'ai');
        this.updateStatus(`Question ${this.currentQuestionIndex + 1} of ${this.questionSequence.length}`);
    }

    extractDataFromMessage(message) {
        const lowerMessage = message.toLowerCase();
        
        // Extract name (multiple patterns)
        if (!this.capturedData.contact_name) {
            const namePatterns = [
                /(?:my name is|i'm|i am|call me|this is)\s+([a-zA-Z]+(?:\s+[a-zA-Z]+)*)/i,
                /^([a-zA-Z]+(?:\s+[a-zA-Z]+)*?)(?:\s+(?:and|from|here|owner|,|\.|!|-))/i,
                /^([a-zA-Z]+(?:\s+[a-zA-Z]+){0,2})/i
            ];
            for (const pattern of namePatterns) {
                const match = message.match(pattern);
                if (match && match[1] && match[1].split(' ').length <= 3) {
                    let name = match[1].trim().replace(/\b(owner|manager|from|and|the|business|company|shop|salon|clinic)\b/gi, '').trim();
                    if (name && name.length > 1) {
                        this.businessData.contact_name = name;
                        this.capturedData.contact_name = true;
                        break;
                    }
                }
            }
        }

        // Extract business name
        if (!this.capturedData.business_name) {
            const businessNamePatterns = [
                /(?:business|company|shop|salon|clinic|restaurant|store|practice)\s+(?:is\s+)?(?:called\s+)?([^.!?,\n]+)/i,
                /(?:run|own|operate)\s+(?:a\s+)?([^.!?,\n]+?)(?:\s+in|\s+located|\s+at|$)/i,
                /called\s+([^.!?,\n]+)/i
            ];
            for (const pattern of businessNamePatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    let businessName = match[1].trim().replace(/\b(is|in|located|here|the|a|called|and)\b/gi, '').trim();
                    if (businessName && businessName.length > 2) {
                        this.businessData.business_name = businessName;
                        this.capturedData.business_name = true;
                        break;
                    }
                }
            }
        }

        // Extract location
        if (!this.capturedData.business_location) {
            const locationPatterns = [
                /(?:in|located in|based in|from|at)\s+([^.!?,\n]+)/i,
                /(?:Jacksonville|Jax|Florida|FL|Miami|Tampa|Orlando|Atlanta|Georgia|Alabama)\b[^.!?,\n]*/i
            ];
            for (const pattern of locationPatterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    let location = match[1].trim().replace(/\b(the|a|is|and)\b/gi, '').trim();
                    if (location && location.length > 2) {
                        this.businessData.business_location = location;
                        this.capturedData.business_location = true;
                        break;
                    }
                } else if (match && match[0]) {
                    this.businessData.business_location = match[0].trim();
                    this.capturedData.business_location = true;
                    break;
                }
            }
        }

        // Extract business type based on current question
        if (!this.capturedData.business_type && this.currentQuestionIndex === 1) {
            // For business type question, use the full response
            this.businessData.business_type = message;
            this.capturedData.business_type = true;
        }

        // Extract pain points based on current question
        if (!this.capturedData.pain_points && this.currentQuestionIndex === 2) {
            this.businessData.pain_points = message;
            this.capturedData.pain_points = true;
        }

        // Extract current solutions based on current question
        if (!this.capturedData.current_solution && this.currentQuestionIndex === 3) {
            this.businessData.current_solution = message;
            this.capturedData.current_solution = true;
        }

        // Extract time savings based on current question
        if (!this.capturedData.time_savings && this.currentQuestionIndex === 4) {
            this.businessData.time_savings = message;
            this.capturedData.time_savings = true;
        }

        // Extract time value based on current question
        if (!this.capturedData.time_value && this.currentQuestionIndex === 5) {
            this.businessData.time_value = message;
            this.capturedData.time_value = true;
        }

        // Extract email and phone from contact details question
        if (this.currentQuestionIndex === 6) {
            // Extract email
            if (!this.capturedData.contact_email) {
                const emailMatch = message.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
                if (emailMatch) {
                    this.businessData.contact_email = emailMatch[1];
                    this.capturedData.contact_email = true;
                }
            }

            // Extract phone
            if (!this.capturedData.contact_phone) {
                const phoneMatch = message.match(/(\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4})/);
                if (phoneMatch) {
                    this.businessData.contact_phone = phoneMatch[1];
                    this.capturedData.contact_phone = true;
                }
            }
        }
    }

    handleConsultationRequest(message) {
        // Add user response to conversation
        this.conversationHistory.push({
            role: 'user',
            content: message
        });

        // Send assessment data to webhook
        this.sendAssessmentToWebhook();
        
        // Show confirmation message
        const name = this.businessData.contact_name ? `, ${this.businessData.contact_name.split(' ')[0]}` : '';
        const businessName = this.businessData.business_name ? ` for ${this.businessData.business_name}` : '';
        this.addMessage(`Perfect${name}! I've sent your detailed assessment${businessName} to JAX AI Consulting. Based on your ${this.businessData.business_type || 'business'} in ${this.businessData.business_location || 'your area'}, someone will reach out within 24 hours to schedule your consultation. Thank you for your interest!`, 'ai');
        
        // Hide input section
        document.getElementById('inputSection').style.display = 'none';
        this.updateStatus('Assessment complete - You will be contacted within 24 hours');
    }

    async sendAssessmentToWebhook() {
        try {
            const functionUrl = window.location.hostname === 'localhost' 
                ? 'http://localhost:8888/.netlify/functions/ai-assessment'
                : '/.netlify/functions/ai-assessment';

            const assessmentPayload = {
                businessData: this.businessData,
                conversationHistory: this.conversationHistory,
                solutionProposal: this.getSolutionFromConversation(),
                contactName: this.businessData.contact_name || '',
                businessName: this.businessData.business_name || '',
                contactEmail: this.businessData.contact_email || '',
                contactPhone: this.businessData.contact_phone || '',
                submittedAt: new Date().toISOString(),
                leadScore: this.calculateLeadScore(),
                tokensUsed: this.totalTokensUsed,
                aiProvider: 'OpenAI ChatGPT-5',
                dataCompleteness: this.getCompletionProgress()
            };

            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    isConsultationRequest: true,
                    assessmentData: assessmentPayload
                })
            });

            if (response.ok) {
                console.log('Assessment data sent to webhook successfully');
            } else {
                console.error('Webhook failed, using email backup');
            }

            // Always open email as backup
            this.openEnhancedEmail();

        } catch (error) {
            console.error('Webhook error:', error);
            this.openEnhancedEmail();
        }
    }

    openEnhancedEmail() {
        const contactName = this.businessData.contact_name || 'Not provided';
        const businessName = this.businessData.business_name || 'Not provided';
        const contactEmail = this.businessData.contact_email || 'Not provided';
        const contactPhone = this.businessData.contact_phone || 'Not provided';

        const emailSubject = `ðŸ”¥ HOT LEAD: ${contactName} from ${businessName} (Score: ${this.calculateLeadScore()}/100)`;
        
        const emailBody = `URGENT: New qualified lead wants consultation!

CONTACT INFORMATION:
===================
Name: ${contactName}
Business: ${businessName}
Location: ${this.businessData.business_location || 'Not provided'}
Type: ${this.businessData.business_type || 'Not provided'}
Email: ${contactEmail}
Phone: ${contactPhone}

ASSESSMENT SUMMARY:
==================
Pain Points: ${this.businessData.pain_points || 'Not provided'}
Current Solutions: ${this.businessData.current_solution || 'Not provided'}
Potential Time Savings: ${this.businessData.time_savings || 'Not provided'}
Time Value: ${this.businessData.time_value || 'Not provided'}
Lead Score: ${this.calculateLeadScore()}/100

FULL CONVERSATION:
==================
${this.conversationHistory.map(msg => `${msg.role.toUpperCase()}: ${msg.content}`).join('\n\n')}

ðŸŽ¯ ACTION REQUIRED: Contact within 24 hours to schedule consultation!`;

        const emailLink = `mailto:hello@jaxaiconsulting.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
        window.open(emailLink, '_blank');
    }

    getSolutionFromConversation() {
        const solutionMessage = this.conversationHistory
            .slice()
            .reverse()
            .find(msg => msg.role === 'assistant' && (
                msg.content.includes('AUTOMATION OPPORTUNITIES') || 
                msg.content.includes('SOLUTION PROPOSAL') ||
                msg.content.includes('ROI ANALYSIS')
            ));
        
        return solutionMessage ? solutionMessage.content : 'Solution proposal generated';
    }

    calculateLeadScore() {
        let score = 25; // Base score
        
        // Data completeness
        const completeness = this.getCompletionProgress();
        score += Math.round(completeness * 0.3);
        
        // Time value scoring
        const timeValue = this.extractTimeValue(this.businessData.time_value);
        if (timeValue >= 200) score += 40;
        else if (timeValue >= 100) score += 30;
        else if (timeValue >= 75) score += 25;
        else if (timeValue >= 50) score += 20;
        else if (timeValue >= 25) score += 10;
        
        // Time savings potential
        const timeSavings = this.extractTimeSavings(this.businessData.time_savings);
        if (timeSavings >= 15) score += 35;
        else if (timeSavings >= 10) score += 25;
        else if (timeSavings >= 5) score += 15;
        else if (timeSavings >= 2) score += 10;
        
        return Math.min(score, 100);
    }

    extractTimeValue(timeValueText) {
        if (!timeValueText) return 0;
        const matches = timeValueText.match(/\$?(\d+(?:,\d{3})*(?:\.\d{2})?)/);
        return matches ? parseFloat(matches[1].replace(/,/g, '')) : 0;
    }

    extractTimeSavings(timeSavingsText) {
        if (!timeSavingsText) return 0;
        const hourMatches = timeSavingsText.match(/(\d+(?:\.\d+)?)\s*(?:hours?|hrs?)/i);
        if (hourMatches) return parseFloat(hourMatches[1]);
        
        const numberMatches = timeSavingsText.match(/(\d+(?:\.\d+)?)/);
        return numberMatches ? parseFloat(numberMatches[1]) : 0;
    }

    async generateSolutionProposal() {
        try {
            const solutionPrompt = `Create a comprehensive AI solution proposal for this business owner using their exact information.

BUSINESS OWNER: ${this.businessData.contact_name || 'Business Owner'}
BUSINESS: ${this.businessData.business_name || 'Their Business'}
LOCATION: ${this.businessData.business_location || 'Location not specified'}
BUSINESS TYPE: ${this.businessData.business_type || 'Small Business'}
MAIN CHALLENGES: ${this.businessData.pain_points || 'Manual processes'}
CURRENT SOLUTIONS: ${this.businessData.current_solution || 'Manual processes'}
POTENTIAL TIME SAVINGS: ${this.businessData.time_savings || '5 hours per week'}
TIME VALUE: ${this.businessData.time_value || '$50 per hour'}

CRITICAL INSTRUCTIONS:
1. Use their EXACT time value and time savings - no assumptions
2. Calculate precise ROI using their real numbers
3. Address them by first name
4. Reference their specific business name and challenges
5. End with ONLY the consultation question - no signatures

PROPOSAL STRUCTURE:

## EXECUTIVE SUMMARY
- Address by first name
- Reference business name and location
- Mention specific challenges from their input

## DETAILED ROI ANALYSIS
- Use EXACT time value and savings from their responses
- Calculate: (time savings Ã— time value Ã— 52 weeks) = annual savings
- JAX AI fee: 10% of annual savings
- Show ROI percentage: ((annual savings - fee) / fee) Ã— 100

## CUSTOM AUTOMATION SOLUTIONS
- 2-3 specific solutions based on their exact challenges
- Reference their business name
- Address their current manual processes

## IMPLEMENTATION TIMELINE
- 6-week timeline
- Pay-for-performance model details

## NEXT STEPS
- "Would you like to schedule an in-person consultation to discuss implementing this solution for [business name]?"

Use only their real data - no placeholders or assumptions. Be specific and personal.`;

            this.addMessage('Creating your personalized automation strategy with precise ROI calculations...', 'thinking');

            const response = await this.getAISolutionResponse(solutionPrompt);
            this.removeLastMessage();
            this.addMessage(response, 'ai');
            
            this.solutionProposalGenerated = true;
            this.updateStatus('Please let me know if you\'d like to schedule a consultation');

        } catch (error) {
            this.removeLastMessage();
            this.showError('Error generating your solution proposal. Please refresh and try again.');
            console.error('Solution generation error:', error);
        }
    }

    async getAISolutionResponse(solutionPrompt) {
        try {
            const functionUrl = window.location.hostname === 'localhost' 
                ? 'http://localhost:8888/.netlify/functions/ai-assessment'
                : '/.netlify/functions/ai-assessment';

            const response = await fetch(functionUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    messages: [{ role: 'user', content: solutionPrompt }],
                    systemPrompt: 'You are an expert AI business consultant. Use ONLY the exact data provided. Never assume numbers. Create personalized proposals without signatures. Be specific and reference the actual business details provided.',
                    maxTokens: 1500
                })
            });

            if (!response.ok) {
                throw new Error(`Backend request failed with status ${response.status}`);
            }

            const data = await response.json();
            const aiResponse = data.content[0].text;

            if (data.usage) {
                this.totalTokensUsed += data.usage.total_tokens;
            }

            this.conversationHistory.push({
                role: 'assistant',
                content: aiResponse
            });

            return aiResponse;

        } catch (error) {
            console.error('Solution API Error:', error);
            throw error;
        }
    }

    addMessage(text, type) {
        const container = document.getElementById('conversationDisplay');
        const message = document.createElement('div');
        message.className = `message ${type}`;
        
        const label = document.createElement('div');
        label.className = 'message-label';
        
        if (type === 'ai') {
            label.textContent = 'JAX AI Consultant (ChatGPT-5)';
        } else if (type === 'user') {
            label.textContent = 'You';
        } else if (type === 'thinking') {
            label.textContent = 'AI is analyzing...';
        }
        
        const content = document.createElement('div');
        content.className = 'message-content';
        
        let formattedText = text
            .replace(/### (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/## (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/# (.*?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/^\* (.*?)$/gm, 'â€¢ $1')
            .replace(/^- (.*?)$/gm, 'â€¢ $1')
            .replace(/^(\d+)\. (.*?)$/gm, '<strong>$1.</strong> $2')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        if (!formattedText.includes('<h3>') && !formattedText.includes('<p>')) {
            formattedText = '<p>' + formattedText + '</p>';
        } else if (formattedText.includes('<br>') && !formattedText.includes('<p>')) {
            formattedText = '<p>' + formattedText + '</p>';
        }
        
        content.innerHTML = formattedText;
        
        message.appendChild(label);
        message.appendChild(content);
        container.appendChild(message);
        
        container.scrollTop = container.scrollHeight;
    }

    removeLastMessage() {
        const container = document.getElementById('conversationDisplay');
        const lastMessage = container.lastElementChild;
        if (lastMessage) {
            container.removeChild(lastMessage);
        }
    }

    showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
}
